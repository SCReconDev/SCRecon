import random
import sys

from fastapi import FastAPI
import httpx
import ipaddress
import asyncio
import re
import xml.etree.ElementTree as ET
from collections import defaultdict

app = FastAPI()

@app.get("/scan/nmapvuln/{timing}/{ip}/{ports}")
async def nmap_vuln_scan(timing: int, ip: str, ports: str):
    if not validate_ip(ip):
        return {"error": "Invalid IP address."}
    if 0 <= timing <= 5:
        process = await asyncio.create_subprocess_exec(
            "nmap", "-sV", "--script", "vuln", "-T", str(timing), "-p", ports,"-oX", "-", ip,
            stdout=asyncio.subprocess.PIPE,
            stderr=asyncio.subprocess.PIPE
        )
        stdout, stderr = await process.communicate()
        print(stdout.decode())
        print("fehler")
        print(stderr.decode())

        VULN_PATTERNS = {
            "CVE": r"CVE-\d{4}-\d{4,7}",
            #"CNVD": r"CNVD-\d{4}-\d+",
            #"SSV": r"SSV:\d+",
            #"EDB": r"EDB-ID:\d+",
            #"PACKETSTORM": r"PACKETSTORM:\d+",
            #"EXPLOITPACK": r"EXPLOITPACK:[A-Z0-9]+",
            #"1337DAY": r"1337DAY-ID-\d+",
            #"MSF": r"MSF:[A-Z0-9\-_]+",
            #"HTTPD": r"HTTPD:[A-F0-9]+",
        }

        root = ET.fromstring(stdout.decode())

        found = defaultdict(set)

        for elem in root.iter():
            if elem.text:
                for name, pattern in VULN_PATTERNS.items():
                    for match in re.findall(pattern, elem.text):
                        found[name].add(match)

        output = ""
        for vuln_type, items in found.items():
            print(f"\n[{vuln_type}] ({len(items)})")
            for v in sorted(items):
                print(" ", v)
                output += v + ","
        output = output.rstrip(",")
        return {
            "vulnerabilities": output
        }
    else:
        return {"error": "Invalid timing."}


def validate_ip(ip):
    try:
        ipaddress.ip_address(ip)
        return True
    except ValueError:
        return False